name: ğŸš€ Build & Deploy Astro Blog

on:
  push:
    branches:
      - main  # å½“ main åˆ†æ”¯æœ‰æ›´æ–°æ—¶è§¦å‘æ„å»º
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # ğŸ‘ˆ å…è®¸æ¨é€åˆ°ä»“åº“åˆ†æ”¯

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ è®¾ç½® Node ç¯å¢ƒï¼ˆè‡ªåŠ¨ç¼“å­˜ npmï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # 3ï¸âƒ£ å®‰è£…ä¾èµ–ï¼ˆå¸¦è‡ªåŠ¨é‡è¯•ï¼‰
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ æ­£åœ¨å®‰è£…ä¾èµ–..."
          for i in 1 2 3; do
            npm ci && break || (echo "âŒ å®‰è£…å¤±è´¥ï¼Œ${i} ç§’åé‡è¯•ç¬¬ $((i+1)) æ¬¡..." && sleep $((i * 5)))
          done
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      # 4ï¸âƒ£ åˆ é™¤æ—§æ„å»ºäº§ç‰©ï¼ˆé˜²æ­¢æ®‹ç•™ï¼‰
      - name: Clean old build
        run: |
          echo "ğŸ§¹ æ¸…ç†æ—§æ„å»ºç›®å½•..."
          rm -rf dist .astro
          echo "âœ… æ¸…ç†å®Œæˆ"

      # 5ï¸âƒ£ æ„å»º Astro é™æ€æ–‡ä»¶
      - name: Build Astro project
        run: |
          echo "ğŸ—ï¸ æ­£åœ¨æ„å»º Astro é¡¹ç›®..."
          npm run build
          echo "âœ… æ„å»ºå®Œæˆ"

      # 6ï¸âƒ£ éƒ¨ç½²åˆ° page åˆ†æ”¯ï¼ˆGitHub Pages æˆ–é™æ€ä»“åº“ï¼‰
      - name: ğŸ“¦ Deploy to page branch
        run: |
          cd dist
          git init
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add .
          COMMIT_MSG=$(printf "%s" "${{ github.event.head_commit.message }}" | tr -d '\n' | tr -d '\r')
          git commit -m "$COMMIT_MSG ==> [$(date +"%Y-%m-%d %H:%M:%S")]"
          git push --force --quiet "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" master:page
          echo "âœ… å·²æ¨é€è‡³ GitHub page åˆ†æ”¯"


      # 7ï¸âƒ£ åŒæ­¥åˆ° CNB ä»“åº“ï¼ˆå¸¦ GitHub commit ä¿¡æ¯ï¼‰
      - name: ğŸŒ Sync to CNB repository
        run: |
          cd dist
          git branch -M main
          git remote add cnb "https://${{ secrets.CNB_USERNAME }}:${{ secrets.CNB_TOKEN }}@cnb.cool/ljxme/lisblogsourcecode.git"
          git fetch cnb || true
          # è·å–å½“å‰ GitHub æäº¤ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=%s)
          GITHUB_COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          git commit --allow-empty -m "ğŸ”„ Sync from GitHub: ${COMMIT_MSG}\nğŸ”— ${GITHUB_COMMIT_URL}"
          git push --force --quiet cnb main
          echo "âœ… å·²åŒæ­¥è‡³ CNB ä»“åº“ï¼ˆå¸¦ GitHub æäº¤ä¿¡æ¯ï¼‰"

      # 8ï¸âƒ£ SSH ç™»å½•æœåŠ¡å™¨å¹¶æ‰§è¡Œæ‹‰å–
      - name: ğŸ”§ SSH Deploy to Server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          port: ${{ secrets.PORT }}
          script: |
            cd /opt/1panel/www/sites/myblog/index/
            git config --global --add safe.directory "$(pwd)"
            git fetch --all --depth=1
            git reset --hard origin/main
            git pull --depth=1
            echo "âœ… å·²æ‹‰å– page åˆ†æ”¯æœ€æ–°å†…å®¹"

      # 9ï¸âƒ£ åˆ·æ–° DogeCloud CDN ç›®å½•ç¼“å­˜
      # æ–‡æ¡£å‚è€ƒï¼š
      # - è·å–è®¿é—®ä»¤ç‰Œï¼ˆè¯·åœ¨ DogeCloud æ§åˆ¶å°åˆ›å»ºå¹¶ä¿å­˜åˆ°ä»“åº“ Secretsï¼‰ï¼šhttps://docs.dogecloud.com/cdn/api-access-token
      # - æäº¤åˆ·æ–°ä»»åŠ¡æ¥å£ï¼ˆç›®å½•åˆ·æ–° type=dirï¼‰ï¼šhttps://docs.dogecloud.com/cdn/api-refresh-add
      # ä¸ºé¿å…æ¥å£å˜æ›´å¯¼è‡´å¤±è´¥ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨é¢„å…ˆåˆ›å»ºçš„è®¿é—®ä»¤ç‰Œ `DOGE_ACCESS_TOKEN`
      - name: â™»ï¸ Refresh CDN Directory
        id: refresh_cdn
        if: success()
        env:
          # åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  Secretsï¼šDOGE_ACCESS_KEYã€DOGE_SECRET_KEY
          DOGE_ACCESS_KEY: ${{ secrets.DOGE_ACCESS_KEY }}
          DOGE_SECRET_KEY: ${{ secrets.DOGE_SECRET_KEY }}
        run: |
          echo "â™»ï¸ æ­£åœ¨åˆ·æ–° CDN ç›®å½•ç¼“å­˜..."
          if [ -z "$DOGE_ACCESS_KEY" ] || [ -z "$DOGE_SECRET_KEY" ]; then
            echo "âŒ ç¼ºå°‘ DOGE_ACCESS_KEY æˆ– DOGE_SECRET_KEYï¼Œè¯·åœ¨ä»“åº“ Secrets ä¸­é…ç½®"; exit 1;
          fi
          pip install --quiet requests
          python - <<'PY'
          import os, json, urllib.parse, hmac, hashlib, requests, sys, re

          def dogecloud_api(api_path, data, json_mode=False):
              """
              è°ƒç”¨å¤šå‰äº‘ APIï¼šè®¡ç®— HMAC-SHA1 ç­¾åå¹¶æäº¤è¯·æ±‚
              :param api_path: æ¥å£è·¯å¾„ï¼ˆç¤ºä¾‹ï¼š/cdn/refresh/add.jsonï¼‰
              :param data:     è¯·æ±‚æ•°æ® dictï¼ˆè¡¨å•æˆ– JSONï¼‰
              :param json_mode: æ˜¯å¦ä»¥ JSON å‘é€ï¼ˆé»˜è®¤è¡¨å•ï¼‰
              :return: (resp_json, resp_text)
              """
              access_key = os.environ['DOGE_ACCESS_KEY']
              secret_key = os.environ['DOGE_SECRET_KEY']
              if json_mode:
                  body = json.dumps(data, separators=(',', ':'))
                  mime = 'application/json'
              else:
                  body = urllib.parse.urlencode(data)
                  mime = 'application/x-www-form-urlencoded'
              sign_str = api_path + "\n" + body
              sign = hmac.new(secret_key.encode('utf-8'), sign_str.encode('utf-8'), hashlib.sha1).hexdigest()
              auth = f"TOKEN {access_key}:{sign}"
              resp = requests.post('https://api.dogecloud.com' + api_path, data=body, headers={'Authorization': auth, 'Content-Type': mime})
              print('ğŸ” å“åº”çŠ¶æ€ç ï¼š', resp.status_code)
              print('ğŸ“¨ å“åº”å†…å®¹ï¼š', resp.text)
              if 200 <= resp.status_code < 300:
                  try:
                      r = resp.json()
                  except Exception:
                      print('âŒ è¿”å›é JSON'); sys.exit(1)
                  if r.get('code') == 200:
                      return r, resp.text
                  else:
                      print('âŒ API è¿”å›é”™è¯¯ï¼š', r.get('msg'))
                      sys.exit(1)
              else:
                  sys.exit(1)

          def main():
              """
              æäº¤ç›®å½•åˆ·æ–°ä»»åŠ¡è‡³ https://blog.ljx.icu/
              ä½¿ç”¨ rtype=path è¿›è¡Œç›®å½•åˆ·æ–°ï¼Œæå–ä»»åŠ¡ IDï¼ˆå¦‚ PREFETCH.TX.xxxxxï¼‰å†™å…¥ GitHub è¾“å‡ºã€‚
              """
              api_path = '/cdn/refresh/add.json'
              urls = ['https://blog.ljx.icu/']
              payload = {'rtype': 'path', 'urls': json.dumps(urls, separators=(',', ':'))}
              r, raw = dogecloud_api(api_path, payload, json_mode=False)

              data = r.get('data') or {}
              task_id = data.get('task_id') or data.get('id') or data.get('taskId') or data.get('task')
              if not task_id and isinstance(raw, str):
                  m = re.search(r'(PREFETCH\.TX\.[A-Za-z0-9_-]+)', raw)
                  if m:
                      task_id = m.group(1)

              if task_id:
                  print('âœ… åˆ·æ–°ä»»åŠ¡æäº¤æˆåŠŸï¼Œä»»åŠ¡ IDï¼š', task_id)
                  github_output = os.environ.get('GITHUB_OUTPUT')
                  if github_output:
                      with open(github_output, 'a', encoding='utf-8') as f:
                          f.write(f"refresh_task_id={task_id}\n")
                  sys.exit(0)
              else:
                  print('âš ï¸ æœªè·å–åˆ°åˆ·æ–°ä»»åŠ¡ IDï¼Œåç»­çŠ¶æ€æŸ¥è¯¢å°†å›é€€ä¸ºç›®å½•è·¯å¾„æŸ¥è¯¢')
                  sys.exit(0)

          if __name__ == '__main__':
              main()
          PY

      # ğŸ”Ÿ è½®è¯¢æŸ¥è¯¢ CDN åˆ·æ–°ä»»åŠ¡çŠ¶æ€ï¼Œç¡®è®¤å®Œæˆåå†ç»“æŸæ„å»º
      - name: â³ Verify CDN Directory Refresh Completion
        if: success()
        env:
          DOGE_ACCESS_KEY: ${{ secrets.DOGE_ACCESS_KEY }}
          DOGE_SECRET_KEY: ${{ secrets.DOGE_SECRET_KEY }}
          REFRESH_TASK_ID: ${{ steps.refresh_cdn.outputs.refresh_task_id }}
        run: |
          echo "ğŸ” æ­£åœ¨æŸ¥è¯¢ CDN åˆ·æ–°ä»»åŠ¡çŠ¶æ€..."
          if [ -z "$DOGE_ACCESS_KEY" ] || [ -z "$DOGE_SECRET_KEY" ]; then
            echo "âŒ ç¼ºå°‘ DOGE_ACCESS_KEY æˆ– DOGE_SECRET_KEYï¼Œè¯·åœ¨ä»“åº“ Secrets ä¸­é…ç½®"; exit 1;
          fi
          pip install --quiet requests
          python - <<'PY'
          import os, json, urllib.parse, hmac, hashlib, requests, sys, time

          def dogecloud_api(api_path, data, json_mode=False):
              """
              è°ƒç”¨å¤šå‰äº‘ APIï¼šè®¡ç®— HMAC-SHA1 ç­¾åå¹¶æäº¤è¯·æ±‚
              :param api_path: æ¥å£è·¯å¾„ï¼ˆç¤ºä¾‹ï¼š/cdn/refresh/query.jsonï¼‰
              :param data:     è¯·æ±‚æ•°æ® dictï¼ˆè¡¨å•æˆ– JSONï¼‰
              :param json_mode: æ˜¯å¦ä»¥ JSON å‘é€ï¼ˆé»˜è®¤è¡¨å•ï¼‰
              :return: å“åº” JSONï¼ˆå­—å…¸ï¼‰ï¼Œå¤±è´¥æ—¶é€€å‡º
              """
              access_key = os.environ['DOGE_ACCESS_KEY']
              secret_key = os.environ['DOGE_SECRET_KEY']
              if json_mode:
                  body = json.dumps(data, separators=(',', ':'))
                  mime = 'application/json'
              else:
                  body = urllib.parse.urlencode(data)
                  mime = 'application/x-www-form-urlencoded'
              sign_str = api_path + "\n" + body
              sign = hmac.new(secret_key.encode('utf-8'), sign_str.encode('utf-8'), hashlib.sha1).hexdigest()
              auth = f"TOKEN {access_key}:{sign}"
              resp = requests.post('https://api.dogecloud.com' + api_path, data=body, headers={'Authorization': auth, 'Content-Type': mime})
              print('ğŸ” å“åº”çŠ¶æ€ç ï¼š', resp.status_code)
              print('ğŸ“¨ å“åº”å†…å®¹ï¼š', resp.text)
              if 200 <= resp.status_code < 300:
                  try:
                      r = resp.json()
                  except Exception:
                      print('âŒ è¿”å›é JSON'); sys.exit(1)
                  if r.get('code') == 200:
                      return r
                  else:
                      print('âŒ API è¿”å›é”™è¯¯ï¼š', r.get('msg'))
                      sys.exit(1)
              else:
                  sys.exit(1)

          def wait_for_refresh_by_path(urls, timeout=300, interval=5):
              """
              è½®è¯¢æŸ¥è¯¢ç›®å½•åˆ·æ–°çŠ¶æ€ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆæˆ–è¶…æ—¶ã€‚
              - è¯·æ±‚ï¼šPOST /cdn/refresh/query.jsonï¼Œå‚æ•°æ”¯æŒ rtype=path ä¸ urlsï¼ˆJSON å­—ç¬¦ä¸²ï¼‰
              - å“åº”ï¼šå½¢å¦‚ { code, msg, data }ï¼Œå…¶ä¸­ data å¯èƒ½åŒ…å« success/progress/status/list ç­‰å­—æ®µ
              :param urls: éœ€è¦åˆ·æ–°çš„ç›®å½•åˆ—è¡¨ï¼ˆç¤ºä¾‹ï¼š['https://blog.ljx.icu/']ï¼‰
              :param timeout: æœ€å¤§ç­‰å¾…ç§’æ•°ï¼ˆé»˜è®¤ 300 ç§’ï¼‰
              :param interval: è½®è¯¢é—´éš”ï¼ˆé»˜è®¤ 5 ç§’ï¼‰
              """
              api_path = '/cdn/refresh/query.json'
              start = time.time()
              payload = {'rtype': 'path', 'urls': json.dumps(urls, separators=(',', ':'))}

              def is_done(data: dict) -> bool:
                  # ç›´æ¥ success=true
                  if data.get('success') is True:
                      return True
                  # è¿›åº¦ 100 æˆ–å­—ç¬¦ä¸²å®Œæˆæ€
                  progress = data.get('progress')
                  if isinstance(progress, (int, float)) and int(progress) >= 100:
                      return True
                  status = data.get('status') or data.get('state') or data.get('message')
                  if isinstance(status, str) and status.lower() in {'success', 'done', 'finished', 'ok'}:
                      return True
                  # åˆ—è¡¨é¡¹å…¨éƒ¨å®Œæˆ
                  lst = data.get('list') or data.get('tasks') or []
                  if isinstance(lst, list) and len(lst) > 0:
                      def item_done(item: dict) -> bool:
                          s = item.get('status') or item.get('state') or item.get('message')
                          p = item.get('progress')
                          return (isinstance(s, str) and s.lower() in {'success','done','finished','ok'}) or (isinstance(p, (int,float)) and int(p) >= 100)
                      return all(item_done(x if isinstance(x, dict) else {}) for x in lst)
                  return False

              while time.time() - start < timeout:
                  r = dogecloud_api(api_path, payload, json_mode=False)
                  data = r.get('data') or {}

                  if is_done(data):
                      print('âœ… åˆ·æ–°ä»»åŠ¡å·²å®Œæˆ')
                      sys.exit(0)

                  # æ‰“å°å¯è¯»è¿›åº¦
                  readable = data.get('status') or data.get('state') or data.get('message') or data.get('progress')
                  print(f'âŒ› åˆ·æ–°çŠ¶æ€ï¼š{readable if readable is not None else "æœªçŸ¥"}ï¼Œ{interval}s åç»§ç»­...')
                  time.sleep(interval)

              print('âŒ ç­‰å¾…è¶…æ—¶ï¼Œåˆ·æ–°ä»»åŠ¡æœªå®Œæˆ')
              sys.exit(1)

          def wait_for_refresh_by_id(task_id, timeout=300, interval=5):
              """
              åŸºäºåˆ·æ–°ä»»åŠ¡ ID ç²¾ç¡®è½®è¯¢æŸ¥è¯¢åˆ·æ–°çŠ¶æ€ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆæˆ–è¶…æ—¶ã€‚
              - è¯·æ±‚ï¼šPOST /cdn/refresh/query.jsonï¼Œå‚æ•°åŒ…å« idï¼ˆæˆ– task_idï¼‰
              - å“åº”ï¼šå½¢å¦‚ { code, msg, data }ï¼Œå…¼å®¹ success/progress/status/list ç­‰å­—æ®µ
              :param task_id: åˆ·æ–°ä»»åŠ¡å”¯ä¸€ IDï¼ˆä¾‹å¦‚ PREFETCH.TX.xxxxxï¼‰
              :param timeout: æœ€å¤§ç­‰å¾…ç§’æ•°ï¼ˆé»˜è®¤ 300 ç§’ï¼‰
              :param interval: è½®è¯¢é—´éš”ï¼ˆé»˜è®¤ 5 ç§’ï¼‰
              """
              if not task_id:
                  print('âš ï¸ æœªæä¾›åˆ·æ–°ä»»åŠ¡ IDï¼Œè·³è¿‡ç²¾ç¡®æŸ¥è¯¢')
                  sys.exit(0)
              api_path = '/cdn/refresh/query.json'
              start = time.time()
              payload = {'id': task_id, 'task_id': task_id}

              def is_done(data: dict) -> bool:
                  if data.get('success') is True:
                      return True
                  progress = data.get('progress')
                  if isinstance(progress, (int, float)) and int(progress) >= 100:
                      return True
                  status = data.get('status') or data.get('state') or data.get('message')
                  if isinstance(status, str) and status.lower() in {'success', 'done', 'finished', 'ok'}:
                      return True
                  lst = data.get('list') or data.get('tasks') or []
                  if isinstance(lst, list) and len(lst) > 0:
                      def item_done(item: dict) -> bool:
                          s = item.get('status') or item.get('state') or item.get('message')
                          p = item.get('progress')
                          return (isinstance(s, str) and s.lower() in {'success','done','finished','ok'}) or (isinstance(p, (int,float)) and int(p) >= 100)
                      return all(item_done(x if isinstance(x, dict) else {}) for x in lst)
                  return False

              while time.time() - start < timeout:
                  r = dogecloud_api(api_path, payload, json_mode=False)
                  data = r.get('data') or {}
                  if is_done(data):
                      print('âœ… åˆ·æ–°ä»»åŠ¡å·²å®Œæˆï¼ˆID æŸ¥è¯¢ï¼‰')
                      sys.exit(0)
                  readable = data.get('status') or data.get('state') or data.get('message') or data.get('progress')
                  print(f'âŒ› åˆ·æ–°çŠ¶æ€ï¼ˆIDï¼‰ï¼š{readable if readable is not None else "æœªçŸ¥"}ï¼Œ{interval}s åç»§ç»­...')
                  time.sleep(interval)

              print('âŒ ç­‰å¾…è¶…æ—¶ï¼Œåˆ·æ–°ä»»åŠ¡æœªå®Œæˆï¼ˆID æŸ¥è¯¢ï¼‰')
              sys.exit(1)

          def main():
              """
              ä»¥ç«™ç‚¹æ ¹ç›®å½•ä¸ºæŸ¥è¯¢ç›®æ ‡ï¼Œè½®è¯¢åˆ·æ–°ç»“æœã€‚
              """
              task_id = os.environ.get('REFRESH_TASK_ID')
              if task_id:
                  wait_for_refresh_by_id(task_id)
              else:
                  urls = ['https://blog.ljx.icu/']
                  wait_for_refresh_by_path(urls)

          if __name__ == '__main__':
              main()
          PY